resolver 192.168.2.1 valid=30s;

set $upstream_web_protege   https://192.168.2.131:1443;

# Remplacer les proxy_pass des modules a tester

set $upstream_monitor   http://mg-dev4:8080;

set $upstream_node_millegrilles   https://192.168.2.131:3001;
set $upstream_react_millegrilles  https://192.168.2.131:3002;

set $upstream_node_coupdoeil      https://192.168.2.131:3003;
set $upstream_react_coupdoeil     https://192.168.2.131:3004;

set $upstream_node_posteur        https://mg-dev4.maple.maceroc.com:3005;
set $upstream_react_posteur       https://mg-dev4.maple.maceroc.com:3006;

set $upstream_node_vitrine        https://mg-dev4.maple.maceroc.com:3007;
set $upstream_react_vitrine       https://mg-dev4.maple.maceroc.com:3008;

set $upstream_node_messagerie     https://mg-dev4.maple.maceroc.com:3009;
set $upstream_react_messagerie    https://mg-dev4.maple.maceroc.com:3010;

set $upstream_redmine             https://mg-dev4.maple.maceroc.com:3011;

set $upstream_node_grosfichiers   https://192.168.2.131:3015;
set $upstream_react_grosfichiers  https://192.168.2.131:3016;
set $upstream_node_fichiers       https://mg-dev4:3021;

include /etc/nginx/conf.d/modules/error_page.conf.include;

# Monitor
location /administration {
  proxy_pass        $upstream_monitor;
  include /etc/nginx/conf.d/component_base.include;
}

# Monitor
location /installation {
  proxy_pass        $upstream_monitor;
  include /etc/nginx/conf.d/component_base.include;
}

location /fichiers {
  proxy_pass        $upstream_node_fichiers;

  # Mapping certificat client pour connexion consignationfichiers
  proxy_ssl_certificate     /certs_mg/pki.nginx.cert;
  proxy_ssl_certificate_key /certs_mg/pki.nginx.key;

  proxy_ssl_trusted_certificate /certs_mg/pki.millegrille;
  proxy_ssl_verify       on;
  proxy_ssl_verify_depth 1;

  include /etc/nginx/conf.d/component_base_auth.include;
}
location /backup {
  proxy_pass        $upstream_node_fichiers;

  # Mapping certificat client pour connexion consignationfichiers
  proxy_ssl_certificate     /certs_mg/pki.nginx.cert;
  proxy_ssl_certificate_key /certs_mg/pki.nginx.key;

  proxy_ssl_trusted_certificate /certs_mg/pki.millegrille;
  proxy_ssl_verify       on;
  proxy_ssl_verify_depth 1;

  include /etc/nginx/conf.d/component_base_auth.include;
}

# Verification de l'authentification
# Invoque pour **chaque** appel a nginx sous une page prive/protegee
location = /millegrilles/authentification/verifier {
  # proxy_pass        $upstream_node_millegrilles;
  proxy_pass        $upstream_web_protege;

  proxy_pass_request_body off; # no need to send the POST body
  proxy_ssl_trusted_certificate /certs_mg/pki.millegrille;

  proxy_set_header  Content-Length "";
  proxy_set_header  X-Real-IP $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto $scheme;
}

# Authentification par usager autre que proprietaire
location = /millegrilles/authentification/verifierUsager {
  # proxy_pass        $upstream_node_millegrilles;
  proxy_pass        $upstream_web_protege;

  proxy_ssl_trusted_certificate /certs_mg/pki.millegrille;

  proxy_set_header  X-Real-IP $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto $scheme;
}

# Chargement de l'application dev React /millegrilles
# /millegrilles
# /millegrilles/sock-js.node
# /millegrilles/main.*
# /millegrilles/static/*
location ~ (^/millegrilles/?$|^/millegrilles/index.html|^/millegrilles/(sockjs-node|main\..*|static/)) {
 # proxy_pass        $upstream_react_millegrilles;
 proxy_pass        $upstream_web_protege;

 proxy_set_header  X-Real-IP $remote_addr;
 proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
 proxy_set_header  X-Forwarded-Proto $scheme;

 # Support WSS
 proxy_set_header  Upgrade $http_upgrade;
 proxy_set_header  Connection $connection_upgrade;
 proxy_set_header  Host $host;
}

# Support socket.io, proteger via auth plugin
location /millegrilles/socket.io {
  # proxy_pass        $upstream_node_millegrilles;
  proxy_pass        $upstream_web_protege;

  include /etc/nginx/conf.d/component_base_auth.include;
}

# Application React - s'occupe de l'authentification (non protege)
location ~ /millegrilles/* {
  # proxy_pass        $upstream_node_millegrilles;
  proxy_pass        $upstream_web_protege;

  proxy_set_header  X-Real-IP $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto $scheme;
}

location ~ (^/coupdoeil$|^/coupdoeil/(sockjs-node|static|main\..*|.*\.hot-update.json)) {
 proxy_pass        $upstream_react_coupdoeil;
 #proxy_pass        $upstream_web_protege;

 proxy_set_header  X-Real-IP $remote_addr;
 proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
 proxy_set_header  X-Forwarded-Proto $scheme;

 # Support WSS
 proxy_set_header  Upgrade $http_upgrade;
 proxy_set_header  Connection $connection_upgrade;
 proxy_set_header  Host $host;
}
location /coupdoeil {
  proxy_pass        $upstream_node_coupdoeil;
  #proxy_pass        $upstream_web_protege;
  #include /etc/nginx/conf.d/component_base_auth.include;
}


# Chargement de /posteur via dev React
# /posteur
# /posteur/sock-js.node
# /posteur/main.*
# /posteur/static/*
#location ~ (^/posteur$|^/posteur/(sockjs-node|static|main\..*)) {
# # Protection via auth plugin
# include /etc/nginx/conf.d/auth.include;
#
# # proxy_pass        $upstream_react_posteur;
# proxy_pass        https://mg-dev4.maple.maceroc.com:3006;
# proxy_set_header  X-Real-IP $remote_addr;
# proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
# proxy_set_header  X-Forwarded-Proto $scheme;
#
# # Support WSS
# proxy_set_header  Upgrade $http_upgrade;
# proxy_set_header  Connection $connection_upgrade;
# proxy_set_header  Host $host;
#}
#location /posteur {
#  # proxy_pass $upstream_node_posteur;
#  proxy_pass        https://mg-dev4.maple.maceroc.com:3005;
#  include /etc/nginx/conf.d/component_base_auth.include;
#}

# Chargement de /vitrine via dev React
# /vitrine
# /vitrine/sock-js.node
# /vitrine/main.*
# /vitrine/static/*
#location ~ (^/vitrine$|^/vitrine/(sockjs-node|static|main\..*|.*\.hot-update.json)) {
# # proxy_pass        $upstream_react_vitrine;
# proxy_pass        https://mg-dev4.maple.maceroc.com:3008;
# proxy_set_header  X-Real-IP $remote_addr;
# proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
# proxy_set_header  X-Forwarded-Proto $scheme;
#
# # Support WSS
# proxy_set_header  Upgrade $http_upgrade;
# proxy_set_header  Connection $connection_upgrade;
# proxy_set_header  Host $host;
#}
#location /vitrine/data {
#  alias /var/opt/millegrilles/37DRyLk3Mog63vW2uqQnPT9jfCUSqKWqRmjUHsu/mounts/nginx/data;
#}
#location /vitrine {
#  # proxy_pass $upstream_node_vitrine;
#  proxy_pass        https://mg-dev4.maple.maceroc.com:3007;
#  include /etc/nginx/conf.d/component_base.include;
#}

# Chargement de /messagerie via dev React
# /messagerie
# /messagerie/sock-js.node
# /messagerie/main.*
# /messagerie/static/*
#location ~ (^/messagerie$|^/messagerie/(sockjs-node|static|main\..*|.*\.hot-update.json)) {
# # proxy_pass        $upstream_react_messagerie;
# proxy_pass        https://localhost:3010;
# proxy_set_header  X-Real-IP $remote_addr;
# proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
# proxy_set_header  X-Forwarded-Proto $scheme;
#
# # Support WSS
# proxy_set_header  Upgrade $http_upgrade;
# proxy_set_header  Connection $connection_upgrade;
# proxy_set_header  Host $host;
#}
#location /messagerie {
#  # proxy_pass $upstream_node_messagerie;
#  proxy_pass        https://localhost:3009;
#  include /etc/nginx/conf.d/component_base_auth.include;
#}

# Chargement de /grosfichiers via dev React
# /grosfichiers
# /grosfichiers/sock-js.node
# /grosfichiers/main.*
# /grosfichiers/static/*
location ~ (^/grosfichiers$|^/grosfichiers/(sockjs-node|static|main\..*|.*\.hot-update.json)) {
 proxy_pass        $upstream_react_grosfichiers;
 #proxy_pass        $upstream_web_protege;

 proxy_set_header  X-Real-IP $remote_addr;
 proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
 proxy_set_header  X-Forwarded-Proto $scheme;

 # Support WSS
 proxy_set_header  Upgrade $http_upgrade;
 proxy_set_header  Connection $connection_upgrade;
 proxy_set_header  Host $host;
}
location /grosfichiers {
  proxy_pass        $upstream_node_grosfichiers;
  #proxy_pass        $upstream_web_protege;
  include /etc/nginx/conf.d/component_base_auth.include;
}
